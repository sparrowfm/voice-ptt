# voice-ptt

One-command push-to-talk voice transcription for macOS using local Whisper AI.

## Quick Reference

- **Install script**: `install.sh` - Main installer (embeds Hammerspoon Lua config)
- **Update script**: `update.sh` - Standalone updater (not embedded)
- **Config location**: `~/.hammerspoon/init.lua` - Generated by installer
- **Version tracking**: `~/.config/voice-ptt/version` - Used by auto-update checker
- **Update check interval**: 7 days (configurable in Lua config)

## Architecture

### Installation Flow
1. Install Homebrew (if needed)
2. Install dependencies: whisper-cpp, sox, Hammerspoon
3. Download Whisper base model (142MB)
4. Generate Hammerspoon config with embedded hotkey
5. Create helper commands: `voice-ptt-hotkey`, `voice-ptt-model`, `voice-ptt-update`
6. Store version in `~/.config/voice-ptt/version`

### Transcription Flow
```
User presses hotkey
  → sox records audio to ~/rec_temp.wav
  → User releases hotkey
  → whisper-cli transcribes (-otxt format)
  → Lua strips internal newlines
  → Text copied to clipboard
  → Auto-paste via Cmd+V
```

## Key Technical Details

### Whisper.cpp Newline Behavior
- **Issue**: whisper-cpp `-otxt` output includes internal `\n` characters from audio segmentation
- **Root cause**: AI model inserts newlines at segment boundaries (documented in whisper.cpp issues #1427, #2381)
- **Solution**: Strip newlines before pasting: `text:gsub("\n", " ")`
- **Location**: install.sh line ~273 in embedded Lua config

### Hammerspoon Console Control
- **Problem**: Console window appears on first launch despite `open -g`
- **Solution**: Explicit close via Lua at top of init.lua:
  ```lua
  if hs.console.hswindow() then
    hs.console.hswindow():close()
  end
  ```

### Auto-Update Pattern
- **Version tracking**: `VERSION="1.1.0"` at top of install.sh
- **Storage**: Version written to `~/.config/voice-ptt/version` during install
- **Periodic check**: Hammerspoon timer runs every 7 days
- **Check file**: `~/.config/voice-ptt/last-check` stores timestamp
- **Version extraction**: `curl + grep '^VERSION='` to parse from GitHub install.sh
- **Notification**: macOS notification with `withdrawAfter = 0` (persistent)

## Development Workflow

### Testing Changes
```bash
# Syntax check
bash -n install.sh

# Test install locally (non-destructive, checks for existing config)
bash install.sh

# Reload Hammerspoon after config changes
open -g hammerspoon://reload
```

### Version Bumps
1. Update `VERSION="X.Y.Z"` in install.sh
2. Commit changes
3. Push to main branch
4. Users will see update notification within 7 days

### Hotkey Configuration
Hotkey is embedded during install via shell variable substitution:
```lua
local mods = $HOTKEY_MODS  -- e.g., {"alt"}
local key = "$HOTKEY_KEY"   -- e.g., "space"
```

Users can change via `voice-ptt-hotkey` command or manual edit.

## Ollama Integration (Advanced Cleanup)

### Homebrew Package Distinction
- **Two packages**: `brew install ollama` (CLI wrapper) ≠ `brew install --cask ollama` (actual app)
- **Wrapper fails** with "could not find ollama app" if app not installed
- **Always use** `--cask` in documentation and scripts
- **Detection**: Check `/Applications/Ollama.app` exists OR `ollama list` works

### Service Requirements
- Ollama service must be running for `ollama pull` to work
- Start: `ollama serve &` or `/Applications/Ollama.app/Contents/Resources/ollama serve &`
- Check: `pgrep -x ollama`
- API endpoint: `http://localhost:11434`

### Common Install Locations
- `/opt/homebrew/bin/ollama` (Apple Silicon Homebrew)
- `/usr/local/bin/ollama` (Intel Homebrew)
- `~/.ollama/ollama` (manual install)
- `/Applications/Ollama.app/Contents/Resources/ollama` (app bundle)

### Text Processing Pipeline
```
Whisper transcription
  ↓ Remove internal newlines
  ↓ Basic cleanup (filler words)
  ↓ Custom dictionary (find/replace)
  ↓ Advanced LLM cleanup (if enabled, uses dictionary as context)
  ↓ Paste to cursor
```

### Custom Dictionary
- **Location**: `~/.config/voice-ptt/dictionary.txt`
- **Format**: `FIND -> REPLACE` or `(?i)FIND -> REPLACE` (case-insensitive)
- **Two-tier**: Basic (instant) + Advanced (LLM context)
- **Management**: `voice-ptt-dictionary` command

## Gotchas

- **Bash heredocs**: Use `<< 'EOF'` (quoted) to prevent shell variable expansion in Lua code
- **Model paths**: Whisper models in `~/Library/Application Support/whisper.cpp/` (with space!)
- **sox permissions**: Microphone access triggered during install (`trim 0 1` for 1-second test)
- **Hammerspoon reload**: Use `open -g hammerspoon://reload` to reload without focusing
- **Update script not embedded**: `update.sh` exists in repo but is recreated as `voice-ptt-update` during install
- **Ollama wrapper vs app**: "could not find ollama app" = have wrapper, need `brew install --cask ollama`

## Repository

- **GitHub**: https://github.com/sparrowfm/voice-ptt/
- **License**: MIT
- **Raw install URL**: https://raw.githubusercontent.com/sparrowfm/voice-ptt/main/install.sh
